{% extends "base.html" %}

{% block extra_styles %}
<style>
    .tap-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        height: 100%; /* Ensure equal height */
        width: 100%; /* Ensure full width of container */
        display: flex;
        flex-direction: column;
    }
    .tap-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .tap-header {
        background-color: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #eee;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .tap-header h5 {
        margin: 0;
        padding: 0;
    }
    .tap-body {
        padding: 20px;
        flex-grow: 1; /* Allow the body to expand */
        display: flex;
        flex-direction: column;
    }
    .tap-beer {
        font-size: 18px;
        margin-bottom: 10px;
    }
    .tap-description {
        margin-top: 10px;
        font-style: italic;
        color: #6c757d;
        flex-grow: 1; /* Let description take available space */
    }
    .tap-details {
        color: #6c757d;
    }
    .tap-actions {
        margin-top: 15px;
    }
    .empty-tap {
        opacity: 0.7;
    }
    .empty-tap .tap-body {
        background-color: #f8f9fa;
    }
    #beer-select {
        max-height: 300px;
    }
    .beer-option {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.15s ease;
    }
    .beer-option:hover {
        background-color: #f8f9fa;
    }
    .beer-option .beer-name {
        font-weight: bold;
    }
    .beer-option .beer-details {
        font-size: 0.85rem;
        color: #666;
        margin-top: 3px;
    }
    .beer-option .beer-description {
        font-size: 0.85rem;
        font-style: italic;
        margin-top: 3px;
        white-space: normal;
        color: #545454;
    }
    .beer-select-container {
        position: relative;
    }
    .beer-options {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        position: absolute;
        width: 100%;
        background-color: white;
        z-index: 1000;
        display: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .beer-search {
        padding-left: 30px;
    }
    .search-icon {
        position: absolute;
        left: 10px;
        top: 10px;
        color: #6c757d;
    }
    .beer-color-dot {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-right: 5px;
        border: 1px solid rgba(0,0,0,0.1);
    }
    /* Style for the beer selection modal */
    .list-group-item.active {
        background-color: #e7f0fd; /* Light blue background */
        color: #333; /* Dark text for better readability */
        border-color: #b8d4f9;
    }
    .list-group-item.active small.text-muted {
        color: #555 !important; /* Ensure description text is visible when selected */
    }
    /* Make all tap rows the same height and width */
    .tap-row {
        display: flex;
        flex-wrap: wrap;
        margin-left: -10px;
        margin-right: -10px;
    }
    .tap-col {
        display: flex;
        margin-bottom: 20px;
        padding-left: 10px;
        padding-right: 10px;
        flex: 0 0 calc(33.333% - 0px);
        max-width: calc(33.333% - 0px);
    }
    
    /* Inline assign button styles */
    .inline-assign-btn {
        display: none;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 5;
        padding: 5px 10px;
        margin-right: 5px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #0d6efd;
    }
    
    .list-group-item.active .inline-assign-btn {
        display: inline-block;
    }
    
    /* Show the assign button on hover for a better UX */
    .list-group-item:hover .inline-assign-btn {
        display: inline-block;
    }
    
    .list-group-item {
        position: relative;
        padding-right: 85px; /* Make room for the assign button */
    }
    
    /* Dark mode support for the inline assign button */
    body.dark-mode .inline-assign-btn {
        background-color: #375a7f;
        border-color: #375a7f;
    }
    
    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        .tap-col {
            flex: 0 0 50%;
            max-width: 50%;
        }
    }
    
    @media (max-width: 767.98px) {
        .tap-col {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>Tap Management</h1>
        <p>Manage your taps and assign beers to them.</p>
    </div>
    <div class="col-auto">
        <div class="input-group">
            <span class="input-group-text">Number of Taps</span>
            <input type="number" class="form-control" id="tap-count" min="1" max="12" value="1">
            <button class="btn btn-primary" id="update-tap-count">Update</button>
        </div>
    </div>
</div>

<div class="row" id="taps-container">
    <!-- Tap cards will be rendered here -->
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirm-message">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Search and Sort Controls for the Beer Selection Modal -->
<div id="beerSelectionModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Beer to Tap</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control search-input" id="beer-search-modal" placeholder="Search beers...">
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="list-group" id="beer-list">
                        <!-- Beer list will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="assign-beer-btn">Assign Beer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentTapId = null;
    let selectedBeerId = null;

    // Function to load taps
    function loadTaps() {
        fetch('/api/taps')
            .then(response => response.json())
            .then(taps => {
                const container = document.getElementById('taps-container');
                container.innerHTML = '';
                
                taps.forEach(tap => {
                    const tapCard = createTapCard(tap);
                    container.appendChild(tapCard);
                });
            })
            .catch(error => console.error('Error loading taps:', error));
    }

    // Function to create a tap card
    function createTapCard(tap) {
        const col = document.createElement('div');
        col.className = 'tap-col';
        
        const card = document.createElement('div');
        card.className = `tap-card ${!tap.beer ? 'empty-tap' : ''}`;
        card.id = `tap-${tap.id}`;
        
        const header = document.createElement('div');
        header.className = 'tap-header';
        header.innerHTML = `
            <h5>Tap ${tap.id}</h5>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary assign-beer" data-tap-id="${tap.id}">
                    <i class="fas fa-beer"></i> Assign Beer
                </button>
                <button class="btn btn-sm btn-outline-danger clear-tap" data-tap-id="${tap.id}">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        `;
        
        const body = document.createElement('div');
        body.className = 'tap-body';
        
        if (tap.beer) {
            body.innerHTML = `
                <div class="tap-beer">
                    <span class="beer-color-dot" style="background-color: ${tap.beer.color || '#6c757d'}"></span>
                    ${tap.beer.name}
                </div>
                <div class="tap-description">${tap.beer.description || 'No description available'}</div>
                <div class="tap-details">
                    <small>Style: ${tap.beer.style || 'N/A'}</small><br>
                    <small>ABV: ${tap.beer.abv || 'N/A'}%</small>
                </div>
            `;
        } else {
            body.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-beer fa-3x mb-3"></i>
                    <p>No beer assigned</p>
                </div>
            `;
        }
        
        card.appendChild(header);
        card.appendChild(body);
        col.appendChild(card);
        return col;
    }

    // Function to load beers for the selection modal
    function loadBeers() {
        fetch('/api/beers')
            .then(response => response.json())
            .then(beers => {
                const beerList = document.getElementById('beer-list');
                beerList.innerHTML = '';
                
                beers.forEach(beer => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.dataset.beerId = beer.id;
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${beer.name}</h6>
                            <small>${beer.abv || 'N/A'}% ABV</small>
                        </div>
                        <p class="mb-1">${beer.style || 'No style specified'}</p>
                        <small class="text-muted">${beer.description || 'No description available'}</small>
                    `;
                    
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.list-group-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        selectedBeerId = beer.id;
                    });
                    
                    beerList.appendChild(item);
                });
            })
            .catch(error => console.error('Error loading beers:', error));
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        loadTaps();
        loadBeers();
        
        // Update tap count
        document.getElementById('update-tap-count').addEventListener('click', () => {
            const count = document.getElementById('tap-count').value;
            fetch('/api/taps/count', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ count: parseInt(count) })
            })
            .then(response => response.json())
            .then(() => loadTaps())
            .catch(error => console.error('Error updating tap count:', error));
        });
        
        // Assign beer button click
        document.querySelectorAll('.assign-beer').forEach(button => {
            button.addEventListener('click', (e) => {
                currentTapId = e.target.closest('.assign-beer').dataset.tapId;
                $('#beerSelectionModal').modal('show');
            });
        });
        
        // Clear tap button click
        document.querySelectorAll('.clear-tap').forEach(button => {
            button.addEventListener('click', (e) => {
                const tapId = e.target.closest('.clear-tap').dataset.tapId;
                document.getElementById('confirm-message').textContent = 'Are you sure you want to clear this tap?';
                document.getElementById('confirm-action-btn').onclick = () => {
                    fetch(`/api/taps/${tapId}/clear`, {
                        method: 'POST'
                    })
                    .then(() => loadTaps())
                    .catch(error => console.error('Error clearing tap:', error));
                    $('#confirmModal').modal('hide');
                };
                $('#confirmModal').modal('show');
            });
        });
        
        // Assign beer from modal
        document.getElementById('assign-beer-btn').addEventListener('click', () => {
            if (currentTapId && selectedBeerId) {
                fetch(`/api/taps/${currentTapId}/assign`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ beer_id: selectedBeerId })
                })
                .then(() => {
                    loadTaps();
                    $('#beerSelectionModal').modal('hide');
                })
                .catch(error => console.error('Error assigning beer:', error));
            }
        });
        
        // Beer search functionality
        document.getElementById('beer-search-modal').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.list-group-item').forEach(item => {
                const beerName = item.querySelector('h6').textContent.toLowerCase();
                const beerStyle = item.querySelector('p').textContent.toLowerCase();
                const beerDesc = item.querySelector('small').textContent.toLowerCase();
                
                if (beerName.includes(searchTerm) || 
                    beerStyle.includes(searchTerm) || 
                    beerDesc.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %} 